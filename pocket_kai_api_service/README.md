# Сервис PocketKAI API

## Аутентификация

Для аутентификации используется пара JWT: Access и Refresh.
Access токен живёт 15 минут, а Refresh - 28 дней _(по умолчанию)_. Время жизни можно изменить через переменные окружения. \
С помощью Refresh-токена можно получить новый Access-токен без повторного ввода логина и пароля.

При входе выдаётся новая пара Access + Refresh. Вход осуществляется через эндпоинт `/api/auth/login`

Refresh-токен одноразовый, при его использовании выдаётся новая пара Access + Refresh,
а старый Refresh-токен перестаёт быть валидным, но срок действия Refresh-токена не обновляется.
Можно сказать, что Refresh-токен - это одна сессия пользователя и таких сессий может быть несколько.
Эндпоинт для выпуска новой пары: `/api/auth/refresh_token_pair`

Refresh-токен можно отозвать, т.е. завершить сессию. Тогда Refresh-токен перестанет быть валидным и получить новый
Access-токен с помощью него не получится.
**НО (!) старые Access токены по-прежнему будут валидными до окончания их срока жизни.**
Эндпоинт для отзыва токена: `/api/auth/revoke_refresh_token`

Payload Access-токена:
- `sub` - ID пользователя
- `type` - тип токена _('access')_
- `iat` - время выпуска
- `role` - роль пользователя
- `permissions` - права пользователя
- `exp` - время окончания срока жизни

Payload Refresh-токена:
- `sub` - ID пользователя
- `jit` - ID токена
- `type` - тип токена _('refresh')_
- `iat` - время выпуска
- `exp` - время окончания срока жизни

### Шифрование
Для шифрования JWT используется алгоритм RSA256 с приватным и публичным ключами.
С помощью приватного ключа сервер авторизации _(т.е. этот)_ подписывает JWT,
этот ключ хранится только на сервере авторизации и только он может выпускать новые токены. А публичным ключом можно
проверить подлинность JWT и расшифровать его, этот ключ могут использовать другие сервисы,
чтобы не зависеть от сервера авторизации.

Ключи хранятся в папке `certs`, имена файлов с ключами можно задать через переменные окружения.

**Выпуск пары RSA приватный ключ + публичный ключ:**
```shell
# Generate an RSA private key, of size 4096
openssl genrsa -out jwt-private.pem 4096
```

```shell
# Extract the public key from the key pair, which can be used in a certificate
openssl rsa -in jwt-private.pem -outform PEM -pubout -out jwt-public.pem
```

Для работы с JWT используется библиотека [PyJWT](https://pyjwt.readthedocs.io/en/latest/). Так как используется RSA256,
для `PyJWT` нужна зависимость `cryptography` (`pyjwt[crypto]`).
